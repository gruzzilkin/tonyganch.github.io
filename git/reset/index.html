<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Tony Ganch</title><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/syntax.css"><link rel="stylesheet" href="/main.css"><link rel="shortcut icon" href="http://github.com/favicon.ico"></head><body><div class="content"><article class="post"><h2>git reset: повернуть время вспять</h2><p>Самые страшные команды в гите: <code>git reset --hard</code> и <code>git push --force</code>.<br>Особенно если выполнены случайно, друг за другом и в репозитории, с которым
работает ещё пара десятков человек.<br>Как быстро исправить ситуацию?<br>Сделать <code>git reset</code>.</p>
<h3 id="Волшебная-формула"><a href="#Волшебная-формула" class="headerlink" title="Волшебная формула"></a>Волшебная формула</h3><p>Команда на все случаи, когда нужно что-то отменить:</p>
<pre><code>$ git reset --hard &lt;commit&gt;
</code></pre><p><code>&lt;commit&gt;</code> в данном случае — та точка, к которой нужно откатиться.</p>
<p>Гит — лапочка и записывает абсолютно всё, что делает: новые коммиты, переключения
между ветками, переписывание истории.<br>Всё, что вам нужно — научиться читать логи.</p>
<h3 id="Отменить-git-push-force"><a href="#Отменить-git-push-force" class="headerlink" title="Отменить git push --force"></a>Отменить <code>git push --force</code></h3><p>Если вы сделали форс-пуш и быстро поняли, что сделали его не туда, ситуацию
легко поправить.<br>Главное — не паниковать.    </p>
<pre><code>$ git push --force origin master

Counting objects: 3, done.
...
a1a1a1..b2b2b2 master -&gt; master
</code></pre><p>Последняя строка говорит, что до пуша последний коммит в удалённом мастере был
<code>a1a1a1</code>, а после пуша последним коммитом стал <code>b2b2b2</code>.<br>Вооружённые этим знанием, делаем <code>reset</code> и ещё один форс-пуш, на этот раз
возвращая предыдущее состояние ветки:</p>
<pre><code>$ git reset --hard a1a1a1
$ git push origin +master
</code></pre><p class="note">
<code><code>git push -f origin master</code></code> и <code><code>git push origin +master</code></code> —
одно и то же.
</p>

<p>Если провернуть всё быстро, никто ничего не заметит.</p>
<h3 id="Отменить-git-reset-hard"><a href="#Отменить-git-reset-hard" class="headerlink" title="Отменить git reset --hard"></a>Отменить <code>git reset --hard</code></h3><p class="note">
Этот трюк сработает только для закоммиченных изменений.
</p>

<p>Бывает, что пара последних коммитов в ветке — лишние.<br>Вы делаете <code>git reset --hard HEAD~3</code>, но случайно удаляете 1 лишний коммит.<br>На сервер ещё ничего не запушено, сделать <code>git pull</code> неоткуда.<br>Что делать?<br>Открываем reflog:</p>
<pre><code>$ git reflog

c3c3c3 HEAD@{0} reset: moving to HEAD~3
b2b2b2 HEAD@{1} commit: Clean up
a1a1a1 HEAD@{2} commit (amend): Fix #42
...
</code></pre><p>Ваша задача — найти в этом логе тот пункт, к которому вы хотите вернуться.<br>В нашем случае мы хотим отменить последнее действие, то есть вернуться ко второй
строке.<br>Делаем хитрый <code>reset</code>:</p>
<pre><code>$ git reset --hard HEAD@{1}

HEAD is now at b2b2b2 Clean up
</code></pre><p>Вуаля, неудачного <code>reset --hard</code> как не бывало.<br>Что же мы сделали?    </p>
<p><code>git reset --hard HEAD@{1}</code> буквально значит: «Хэй, гит, покажи мне файлы в том
виде, в каком они были 1 действие назад».<br>Обратите внимание, что под действием имеется в виду запись в рефлоге.
Например, если вы сделаете <code>git reset -i HEAD~6</code>, в зависимости от того, что вы
натворите во время рибейза, в логе может появиться хоть 20 новых записей.<br>И каждую из них можно использовать для <code>reset</code>.</p>
<p>Вместо <code>HEAD@{1}</code> можно использовать более замысловатые указания, например:</p>
<pre><code>$ git reset --hard master@{one.week.ago}
</code></pre><p>Этой командой мы просим показать мастер недельной давности.<br>О том, как ещё можно указать нужный коммит, <a href="http://git-scm.com/docs/gitrevisions.html" target="_blank" rel="external">читайте в
документации</a>.</p>
<h3 id="Отменить-git-rebase-i"><a href="#Отменить-git-rebase-i" class="headerlink" title="Отменить git rebase -i"></a>Отменить <code>git rebase -i</code></h3><p>По тому же принципу можно отменить и недавний <code>rebase</code>:</p>
<pre><code>$ git reflog

c3c3c3 HEAD@{1}: rebase -i (finish): returning to refs/heads/branch
b2b2b2 HEAD@{2}: rebase -i (pick): Add cool method
a1a1a1 HEAD@{3}: checkout: moving from branch to a1a1a1
a1a1a1 HEAD@{4}: commit (amend): Add cool method
...
</code></pre><p>Ищем коммит перед чекаутом и откатываемся:</p>
<pre><code>$ git reset --hard HEAD@{4}
</code></pre></article><footer class="footer"><p>Feel free to drop me a line <a href="mailto:tonyganch+tg.com@gmail.com" title="by mail">by mail</a> or <a href="https://twitter.com/tonyganch" title="via twitter" target="_blank" rel="external">via twitter</a>.</p><p>Other notes:</p><ul><li><a href="/csscomb/csscomb-core/">CSScomb Core: postprocessor in 15 mins</a></li><li><a href="/shell/cp-vs-cat/">Отличие cp и cat</a></li><li><a href="/edu/courses-fall-13/">Обзор курсов для биоинформатиков</a></li><li><a href="/git/rebase/">git rebase: порядок в локальных ветках</a></li></ul></footer></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-41864668-1', 'tonyganch.com');
ga('send', 'pageview');</script><script>(function (d, w, c) {
  (w[c] = w[c] || []).push(function() {
    try {
      w.yaCounter21565555 = new Ya.Metrika({id:21565555,
              clickmap:true,
              trackLinks:true,
              accurateTrackBounce:true});
    } catch(e) { }
  });
  var n = d.getElementsByTagName("script")[0],
    s = d.createElement("script"),
    f = function () { n.parentNode.insertBefore(s, n); };
  s.type = "text/javascript";
  s.async = true;
  s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";
  if (w.opera == "[object Opera]") {
    d.addEventListener("DOMContentLoaded", f, false);
  } else { f(); }
})(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="//mc.yandex.ru/watch/21565555" style="position:absolute; left:-9999px;" alt=""></div></noscript></body></html>